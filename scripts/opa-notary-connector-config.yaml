apiVersion: v1
kind: ConfigMap
metadata:
  name: opa-notary-connector-config
  namespace: webhook
data:
  trust.yaml: |
    repositories:
      - name: "localhost.*"
        priority: 10
        trust:
          enabled: true
          trustServer: "https://notary-server.notary.svc.cluster.local:4443"
          signers:
          - role: "targets/jenkins"
            publicKey: "LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSURDakNDQWZJQ0NRQzdDNHZqQnN0bW96QU5CZ2txaGtpRzl3MEJBUXNGQURCSE1ROHdEUVlEVlFRS0RBWlQKU1VkSVZWQXhGVEFUQmdOVkJBc01ESEJ5YjJSMVkzUXRkR1ZoYlRFZE1Cc0dBMVVFQXd3VWIzQmhMVzV2ZEdGeQplUzFqYjI1dVpXTjBiM0l3SGhjTk1qQXdOekUwTURrd01ESTBXaGNOTWpFd056RTBNRGt3TURJMFdqQkhNUTh3CkRRWURWUVFLREFaVFNVZElWVkF4RlRBVEJnTlZCQXNNREhCeWIyUjFZM1F0ZEdWaGJURWRNQnNHQTFVRUF3d1UKYjNCaExXNXZkR0Z5ZVMxamIyNXVaV04wYjNJd2dnRWlNQTBHQ1NxR1NJYjNEUUVCQVFVQUE0SUJEd0F3Z2dFSwpBb0lCQVFDNWZsTk9rVXNTeFkwTW5uRjExMjJnYktFWk9mQ2R6cWlPUXVpeFBMVmEwc0huL2FEamVDQUk1K1VmCi9QRVdOL1JiZzJVdCtjZHNEUDFVV3RCMVJ6M1JvUDBZTnNtS3UyNHpvLzdTS2V4dXlFcFljalhQM1FtN3hKUEgKaXJRV2swcGNHYnIzMjJPWlRDK0t4Y0E1VVh5NGFpbElONUVIbGovcU9xM1Nzd3R5bG9GbGxBbkViRmRHcDRxWQpTWkFNczhoa0FLZU93REJjUEcxQW1WR0pOdGlrOWNscFlqSEdyUXBTOVd3OVgvUTVPNU8vK0gxSmF4ZnNCMElNCmZOdGxmTlhkTGs0STFmeGtjcTAvWlZoQ1Vmd2ZJT3NJNVdBaklVK3ZLQmx0QytENE82bUJtUmxJRDlUclZtcTEKb21KM0tRNjNZUFpHMVYxNTRnM2NhTU9KakpVNUFnTUJBQUV3RFFZSktvWklodmNOQVFFTEJRQURnZ0VCQUNJcwp6VWsrWFk0NzJHSHQxWjl5VWdzOGkyN3pHQ0hUTUp3b2V3Y0RpL2FwQ0pNcFZHT3gvMEVsR1cxY2xySVZSbjhOCkN5a3NPaFlXbnBqVUVVRGYyZHY1SkRHSGpBK0ExTFNUUEVRYXhCTXEvOEhkekN1WFdsN2xrTDdXWW9KWWQvOWkKTFRIOUpBVkNtckh6VklLeWd3d1ZSVHIwZVhRbGJ1ZnpFd01TU0FUWFJmMTFwekorazZyVE1icmNIT2pJb3FreQpIVVZCOHJsb3RUMUgxdFBUOVVzcUhoR0N3eUdad2MwSkNSSXZwemJsdUc4ZUFCL1gxWXdmblQzbG9iQzczT2VXCnd0ZkdTd25EN3IwS2E0YWdoQVMraWtRNDdtdklIWFVOTzU3WUt3dXJkUllrMjZxQzZqRTZRM3haU1J3MC92SkIKbm1SaUl6SmJUWUQvYVluT3N6WT0KLS0tLS1FTkQgQ0VSVElGSUNBVEUtLS0tLQo="
---
apiVersion: v1
kind: Secret
type: kubernetes.io/tls
metadata:
  name: notary-server-crt
  namespace: webhook
data:
  ca.crt: LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUM0ekNDQWN1Z0F3SUJBZ0lSQU9nRUUyNnZYcGRFWDRTaVc5aENJTU13RFFZSktvWklodmNOQVFFTEJRQXcKRVRFUE1BMEdBMVVFQXhNR2JtOTBZWEo1TUI0WERUSXdNRGN4TkRBNE1EQTFOVm9YRFRJd01UQXhNakE0TURBMQpOVm93RVRFUE1BMEdBMVVFQXhNR2JtOTBZWEo1TUlJQklqQU5CZ2txaGtpRzl3MEJBUUVGQUFPQ0FROEFNSUlCCkNnS0NBUUVBM3hHTG9HQnA4cldDRHg4MEdCeFBOcEI5WG1kRjNOUmRCYTJwTzNOeEtvby9sU0ZlMnNSUWkyVjkKZm1MelluMGVJcE1DbzRtcGdzY3k1UkR0WEJIZzF0NzZuY1luNGVDRHZ1UUZ4RXc2Q1U4QjJ3S1VycVhqdE1QcQozRmozVXdqNlBwRndwRzkxL3ZyS3c4c1h6Z21EMyt6NWVaMW13WXlwQ2lYbEI4UVBORG42NHZDZFMzNmhPVzFMCk8zV1BvU0xvSE5lSEtqNUUvU0h2YmJUcDVmSHl5TjEvM1hQQmJ4NEJLc1lIdDZRclduQUN2dzRyVTBHZjQ2THoKZm5zMmF1UEVuQ1czMitEK0E0eEJtYXplMURXWXNwbTd6WE1JdkFVVERpZjdQUkdpdGtBNTVYTXJ5WXRpV0pCdwpNTnlpc0pkMHZxZldsUjBwVjRWeTN0TXBaRG9VaVFJREFRQUJvell3TkRBT0JnTlZIUThCQWY4RUJBTUNBcVF3CkR3WURWUjBUQVFIL0JBVXdBd0VCL3pBUkJnTlZIUkVFQ2pBSWdnWnViM1JoY25rd0RRWUpLb1pJaHZjTkFRRUwKQlFBRGdnRUJBTE5pRVQyUDVDTnFRQ1Vrc2VnZEE2MGNjdjJtSit0MThqeG4vMGtqeVdlbE1kQzExZTExT2pjTQoreVhXbm5xVG9pS01DTTRPY0RXR0lPK2N5VUcrZ2VTMVZoT2xoR0ZnejJkN3dLdkVUMVpPWjlnRVJUT0pBdy9YCkQ1UUdGeEJRMkxiN0JidVRGZGpQakdXN1pNcWF6SFdidU5rc1hMZlp3K2Q0VU4vM2U0Z0NiM0RiVmpTTDRlZTcKSjdrMVdvZlZYUXprZlVpdW1sbVJkeGYyY3l4TkFpRE5uYmJLL2dMdnFYNm94RDNmcFdsQm1MOThYaTRLSmFDRgo3Q2M0eHpUeXJObkZCTFpqRHRwQXRWRnF6WHhGOFJZekhudWE4djRPM1h2QkI0TUIwTHFSMWFERDBUMjJTLzVWClk2Y1VuZi9yZ0l6WFpxTmNvcG5XY2t0a1YyalNNTG89Ci0tLS0tRU5EIENFUlRJRklDQVRFLS0tLS0K
  tls.crt: LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUMzakNDQWNhZ0F3SUJBZ0lRWkswRUFHNEQ1Rm0wdmV6MUNTMkRnREFOQmdrcWhraUc5dzBCQVFzRkFEQVIKTVE4d0RRWURWUVFERXdadWIzUmhjbmt3SGhjTk1qQXdOekUwTURnd01UQXdXaGNOTWpBeE1ERXlNRGd3TVRBdwpXakFwTVE4d0RRWURWUVFLRXdadWIzUmhjbmt4RmpBVUJnTlZCQU1URFc1dmRHRnllUzF6WlhKMlpYSXdnWnN3CkVBWUhLb1pJemowQ0FRWUZLNEVFQUNNRGdZWUFCQUJSbS9kME5sQWhtRUlaYUJnUnd1KzR3MTd2UlFzTlRHNW0KU3creDQ4bzBUQXdzazRwb0FJSjBSWS9pb0VjSFRUdU1UYUl4enIvc2JwT244SWVFQ0x2Z1NBRjJpamxPVzJxdApNTmZ1ZkE3RGpkS2hObm9jRVpySjJjcHQyencxYnN0djZtNDZWS3c4WHlob0dsYnFsdytnVEhOTzY4dzdlVjQrCnpnZ0dnRm5IMFhQcnZLT0JvVENCbmpBT0JnTlZIUThCQWY4RUJBTUNCYUF3SFFZRFZSMGxCQll3RkFZSUt3WUIKQlFVSEF3RUdDQ3NHQVFVRkJ3TUNNQXdHQTFVZEV3RUIvd1FDTUFBd1h3WURWUjBSQkZnd1ZvSU5ibTkwWVhKNQpMWE5sY25abGNvSU1ibTkwWVhKNWMyVnlkbVZ5Z2dsc2IyTmhiR2h2YzNTQ0UyNXZkR0Z5ZVMxelpYSjJaWEl1CmJHOWpZV3lDRjI1dmRHRnllUzF6WlhKMlpYSXViRzlqWVd4b2IzTjBNQTBHQ1NxR1NJYjNEUUVCQ3dVQUE0SUIKQVFCUVFJYU5rczdQMFVGS1p2aUlTMG5ydWlqRFFrZTNZS1BXNmFFZnVUeHhkTFdoeVk1Rm9FMmpwSHlEQXZ0WQo0aUFJaFZBR081R2s1MWhQUENJUHFkMGZmaE1maDE1VmlPZUE0TkhkODVhanJIcmdMVjZtRDJBU0JjeWRIUzZUClRXcWZmMkg0V21mSHZxWDVsSG1xTmEzMmQwaU9qeXptcUY4bVM4R3l6WjNvdzZVSDFBMHVyMWlpMlY2dzNQTVIKdW9zMG5mVU1VOUNKQmZKajhXR29YaEc2RWdNakJ2dTl5NEJRMlprNlhXWi9QLzYycFZ4amFHY2pYTVBlS29JYgo5bndzS3RhRVNaSHMrdUxpMnZ2NVd1T0MrN1lDN050cW0rQ0VkWkpBcFV6Z1RLWkZYbnUvRld2RFlRRVNxc0pvCkljU1lwZ3AyQUhUejc0U2JOM1NUbnhLZQotLS0tLUVORCBDRVJUSUZJQ0FURS0tLS0tCg==
  tls.key: LS0tLS1CRUdJTiBFQyBQUklWQVRFIEtFWS0tLS0tCk1JSGNBZ0VCQkVJQUl4U2svRUdaNmZxYkpxWTVENDIzenUyUWZhRFhkVG5oZ0ZiSnJETy9ORnFhRllUa01DcVEKZVVvbTBvVXRaOEhEcVowT0hlZDhTbUo1N3VYbnFJNlNmZUNnQndZRks0RUVBQ09oZ1lrRGdZWUFCQUJSbS9kMApObEFobUVJWmFCZ1J3dSs0dzE3dlJRc05URzVtU3creDQ4bzBUQXdzazRwb0FJSjBSWS9pb0VjSFRUdU1UYUl4CnpyL3NicE9uOEllRUNMdmdTQUYyaWpsT1cycXRNTmZ1ZkE3RGpkS2hObm9jRVpySjJjcHQyencxYnN0djZtNDYKVkt3OFh5aG9HbGJxbHcrZ1RITk82OHc3ZVY0K3pnZ0dnRm5IMFhQcnZBPT0KLS0tLS1FTkQgRUMgUFJJVkFURSBLRVktLS0tLQo=
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: opa-notary-connector-rules
  namespace: webhook
  labels:
    openpolicyagent.org/policy: rego
data:
  rules.rego: |-
    package kubernetes.admission

    image = {
      "Pod": "spec/containers/%v/image",
      "Deployment": "spec/template/spec/containers/%v/image",
      "Daemonset": "spec/template/spec/containers/%v/image",
      "Job": "spec/template/spec/containers/%v/image",
      "CronJob": "spec/jobTemplate/spec/template/spec/containers/%v/image",
      "ReplicationController": "spec/template/spec/containers/%v/image",
      "StatefulSet": "spec/template/spec/containers/%v/image",
      "ReplicaSet": "spec/template/spec/containers/%v/image"
    }

    deny[msg] {
      path_template := image[input.request.kind.kind]
      path := sprintf(path_template, [1])
      msg := sprintf("Don't want to work today %v", [path])
    }
